<html>
<head>
	<title>FOE Forge Point Calculator</title>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css">
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="//cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
</head>
	<body>
		<div class="container">
			<div class="row clearfix">
				<div class="col-md-12 column">
					<nav class="navbar navbar-default" role="navigation">
						<div class="navbar-header">
							 <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button> <a class="navbar-brand" href="#">TheOrbenOnes FOE Tools</a>
						</div>
						<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                            <ul class="nav navbar-nav">
								<li>
									<a href="fp_calc.html">Forge Point Calculator</a>
								</li>
								<li>
									<a href="gb_calc.html">Snipe Calculator</a>
                                </li>
                                <li class="active">
                                    <a href="gb_finder.html">GB Finder</a>
                                </li>
							</ul>
						</div>
					</nav>
					<div class="jumbotron">
						<h1>
							GB Finder
						</h1>
						<p>
						<form role="form">
							<div class="form-group">
								 <label for="sess">SessionID</label><input class="form-control" id="sess" type="text" />
                            </div>
                            <div class="form-group">
								 <label for="pn">Point Threshold</label><input class="form-control" id="pn" type="text" />
                            </div>
                            <div class="form-group col-md-6">
								 <label for="pn">Pages to Scan(50 gbs per page)</label><input class="form-control" id="pgs" type="text" />
                            </div>
                            <div class="form-group col-md-6">
								 <label for="arcbonus">My Arc Bonus</label><input class="form-control" id="arcbonus" type="text" value="1" />
                            </div>
                            <button type="button" class="btn btn-default btn-calculate-fp">Find</button>
							<button type="button" class="btn btn-default btn-scan-hood-fp">Scan CLan</button>
						</form>
						</p>
						<p>
                            Results:<br />
                            <table id="gbs" class="display" width="100%">
                                <thead>
                                    <tr>
                                        <td>Player</td>
                                        <td>GB</td>
                                        <td>Type</td>
                                        <td>Level</td>
                                        <td>Current</td>
                                        <td>Remaining</td>
                                        <td>Actions</td>
                                    </tr>
                                    <tbody id="watchlist_body">

                                    </tbody>
                                </thead>
                            </table>
							<span id="calc_results">&nbsp;</span>
						</p>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			$(document).ready(function() {
                var tbl = $('#gbs').DataTable({
                    "processing": true,
                    "columns": [
                        {"data": "player.name", "width": "20%", "render": function(data, type, row) {
                            if('player_rank' in row) {
                                return '[' + row.player_rank + ']' + row.player.name;
                            } else {
                                return row.player.name;
                            }
                        }},
                        {"data": "name", "width": "20%"},
                        {"data": "type", "width": "10%"},
                        {"data": "level", "width": "10%"},
                        {"data": "", "width": "20%", "render": function(data, type, row) {
                            return row.points + ' / ' + row.requiredPoints;
                        }},
                        {"data": "", "width": "10%", "render": function(data, type, row) {
                            return row.requiredPoints - row.points;
                        }},
                        {"data": "", "width": "10%", "render": function(data, type, row) {
                            var remainder = row.requiredPoints - row.points;
                            return '<button class="btn btn-info" data-remainder="' + remainder + '" data-eid="' + row.entityId + '" data-pid="' + row.player.player_id + '"><span class="glyphicon glyphicon-question-sign"></span> Info</button>';
                        }}
                    ]
                });

                $(document).delegate('.btn-scan-hood-fp', 'click', function(b) {
                    var sessionID = $('#sess').val();
                    $.post('./php/get_clan.php', {session: sessionID}, function(data) {
                        var d = JSON.parse(data);
                        $.each(d, function(i, gb) {
                            gb.type = gb.player_type;
                            gb.points = gb.current_progress;
                            gb.requiredPoints = gb.max_progress;
                            add_to_list('clan', gb);
                        })
                        console.log(data);
                    })
                })

                $(document).delegate('.btn-info', 'click', function(b) {
                    var eid = $(b.currentTarget).data('eid');
                    var pid = $(b.currentTarget).data('pid');
                    var remainder = $(b.currentTarget).data('remainder');
                    var places = [];
                    $.post('./php/get_single_gb.php', {session: $('#sess').val(), eid: eid, pid: pid}, function(data) {
                        var d = JSON.parse(data);
                        $.each(d, function(i, obj) {
                            if(obj.requestClass === 'GreatBuildingsService') {
                                //this is the one we want
                                $.each(obj.responseData.rankings, function(x, rank) {
                                    if('reward' in rank) {
                                        var my_reward = parseFloat($('#arcbonus').val()) * parseInt(rank.reward.strategy_point_amount);
                                        var can_win = can_win_points(rank);
                                        places.push({rank: rank.rank, remainder: remainder, can_win: can_win, points: rank.forge_points, reward: rank.reward.strategy_point_amount, my_reward: my_reward})
                                    }                                    
                                })
                                /*@TODO Steve add the display */
                                console.log(places);
                            }
                        })
                    })
                    //got them both now just need to query for them
                })
				$(document).delegate('.btn-calculate-fp', 'click', function(e)	{
                    $('#gbs').DataTable().clear();
                    var page = 0;
                    var sessionID = $('#sess').val();
                    var watch_list = [];
                    var clan_list = [];
                    var hood_list = [];
                    var friend_list = [];
                    var pages_to_scan = $('#pgs').val();
                    for(i = page; i < pages_to_scan; i++) {
                        
                        $.post('grab_data.php', {session: sessionID, page: i}, function(data) {
                            var d = JSON.parse(data);
                            $.each(d, function(i, obj) {
                                if(obj.requestClass === "RankingService") {
                                    //this is the one we want
                                    var gbs = obj.responseData.rankings;
                                    $.each(gbs, function(x, gb) {
                                        if(typeof gb.points === 'undefined') {
                                            gb.points = 0;
                                        }
                                        if(gb.player.is_friend) {
                                            console.log(gb);
                                            add_to_list('friend', gb);
                                        } else if(gb.player.is_guild_member) {
                                            console.log(gb);
                                            add_to_list('clan', gb)
                                        } else if(gb.player.is_neighbor) {
                                            console.log(gb);
                                            add_to_list('hood', gb)
                                        }
                                    })
                                }
                            })
                        })
                        console.log('scanned page: ' + i);
                    }
				});

                function add_to_list(type, obj) {
                    var pt = $('#pn').val();
                    if(parseInt(obj.requiredPoints) - parseInt(obj.points) > parseInt(pt)) {
                        return;
                    }
                    var css = '';
                    obj.type = type;
                    var newRow = obj;
                    $('#gbs').DataTable().row.add(newRow).draw();
                    console.log(obj);
                }

                function can_win_points(rank)   {
                    var remainder = rank.remainder;
                    var reward = rank.my_reward;
                    var them = rank.points;
                    if(them - remainder > 0) {
                        //can still pass them
                        var p_to_p = them + 1;
                        var new_r = remainder - p_to_p;
                        var lockpts = new_r / 2;
                        if(p_to_p + lockpts < reward) {
                            return reward - (p_to_p + lockpts);
                        } else {
                            return false;
                        }                        
                    } else {
                        return false;
                    }
                }
			});
		</script>
	</body>
</html>